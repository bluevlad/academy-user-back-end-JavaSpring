<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.academy.mapper.EventMapper">

    <!-- 이벤트 목록 조회 -->
    <select id="eventList" parameterType="hashMap" resultType="hashMap">
        SELECT * FROM (
            SELECT A.*, @rownum := @rownum + 1 AS rnum
            FROM (
                SELECT EVENT_NO,
                    LIST_THUMBNAIL,
                    TITLE,
                    DATE_FORMAT(STR_TO_DATE(START_DATE, '%Y%m%d'), '%Y-%m-%d') START_DATE,
                    START_TIME,
                    DATE_FORMAT(STR_TO_DATE(END_DATE, '%Y%m%d'), '%Y-%m-%d') END_DATE,
                    END_TIME,
                    IFNULL(HIT, 0) HIT,
                    (SELECT COUNT(EVENT_NO) FROM TB_EVENT_FILE WHERE EVENT_NO = T.EVENT_NO) ATTACH_FILE,
                    DATE_FORMAT(REG_DT, '%Y-%m-%d') REG_DT,
                    (SELECT COUNT(EVENT_NO) FROM TB_EVENT_OPTION2 WHERE EVENT_NO = T.EVENT_NO) OPTION2_CNT,
                    CASE
                        WHEN START_DATE > DATE_FORMAT(NOW(), '%Y%m%d') THEN '대기중'
                        WHEN START_DATE <![CDATA[<=]]> DATE_FORMAT(NOW(), '%Y%m%d')
                            AND CONCAT(END_DATE, END_TIME) >= DATE_FORMAT(NOW(), '%Y%m%d%H') THEN '진행중'
                        WHEN CONCAT(END_DATE, END_TIME) <![CDATA[<]]> DATE_FORMAT(NOW(), '%Y%m%d%H') THEN '완료'
                    END STATUS,
                    (SELECT M.USER_NICKNM FROM TB_MA_MEMBER M WHERE M.USER_ID = T.REG_ID) CREATENAME,
                    LOCATE('1', NOTICE_GUBUN) AS ISNOTICE_TOP
                FROM TB_EVENT_INFO T
                WHERE OPEN_YN = 'Y'
                <choose>
                    <when test='EVENT_TYPE == "L"'>
                        AND ONOFF_DIV = 'L'
                    </when>
                    <when test='EVENT_TYPE == "O"'>
                        AND ONOFF_DIV = 'O'
                    </when>
                    <when test='EVENT_TYPE == "F"'>
                        AND ONOFF_DIV = 'F'
                    </when>
                    <when test='EVENT_TYPE == "A"'>
                        AND ONOFF_DIV IN ('L', 'O', 'F')
                    </when>
                    <otherwise>
                        AND ONOFF_DIV = 'L'
                    </otherwise>
                </choose>
                <if test="SEARCHTEXT != null and SEARCHTEXT != ''">
                    <choose>
                        <when test='SEARCHKIND == "SEARCHSUBJECT"'>
                            AND TITLE LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                        </when>
                        <when test='SEARCHKIND == "SEARCHCONTENT"'>
                            AND CONTENTS_TEXT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                        </when>
                        <otherwise>
                            AND (TITLE LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                                OR CONTENTS_TEXT LIKE CONCAT('%', #{SEARCHTEXT}, '%'))
                        </otherwise>
                    </choose>
                </if>
                <if test='SEARCHINGLIST != null and SEARCHINGLIST == "Y"'>
                    AND START_DATE <![CDATA[<=]]> DATE_FORMAT(NOW(), '%Y%m%d')
                    AND CONCAT(END_DATE, END_TIME) >= DATE_FORMAT(NOW(), '%Y%m%d%H')
                </if>
                ORDER BY REG_DT DESC, END_DATE DESC, CAST(EVENT_NO AS UNSIGNED) DESC
            ) A, (SELECT @rownum := 0) r
        ) T
        WHERE rnum > #{startNo} AND rnum <![CDATA[<=]]> #{endNo}
    </select>

    <!-- 이벤트 건수 조회 -->
    <select id="eventListCount" parameterType="hashMap" resultType="int">
        SELECT COUNT(*) CNT
        FROM TB_EVENT_INFO T
        WHERE OPEN_YN = 'Y'
        <choose>
            <when test='EVENT_TYPE == "L"'>
                AND ONOFF_DIV = 'L'
            </when>
            <when test='EVENT_TYPE == "O"'>
                AND ONOFF_DIV = 'O'
            </when>
            <when test='EVENT_TYPE == "F"'>
                AND ONOFF_DIV = 'F'
            </when>
            <when test='EVENT_TYPE == "A"'>
                AND ONOFF_DIV IN ('L', 'O', 'F')
            </when>
            <otherwise>
                AND ONOFF_DIV = 'L'
            </otherwise>
        </choose>
        <if test="SEARCHTEXT != null and SEARCHTEXT != ''">
            <choose>
                <when test='SEARCHKIND == "SEARCHSUBJECT"'>
                    AND TITLE LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <when test='SEARCHKIND == "SEARCHCONTENT"'>
                    AND CONTENTS_TEXT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <otherwise>
                    AND (TITLE LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                        OR CONTENTS_TEXT LIKE CONCAT('%', #{SEARCHTEXT}, '%'))
                </otherwise>
            </choose>
        </if>
        <if test='SEARCHINGLIST != null and SEARCHINGLIST == "Y"'>
            AND START_DATE <![CDATA[<=]]> DATE_FORMAT(NOW(), '%Y%m%d')
            AND CONCAT(END_DATE, END_TIME) >= DATE_FORMAT(NOW(), '%Y%m%d%H')
        </if>
    </select>

    <!-- 이벤트 상세 조회 -->
    <select id="eventDetail" parameterType="hashMap" resultType="hashMap">
        SELECT EVENT_NO,
            TITLE,
            DATE_FORMAT(REG_DT, '%Y-%m-%d') REG_DT,
            DATE_FORMAT(STR_TO_DATE(START_DATE, '%Y%m%d'), '%Y-%m-%d') START_DATE,
            START_TIME,
            DATE_FORMAT(STR_TO_DATE(END_DATE, '%Y%m%d'), '%Y-%m-%d') END_DATE,
            END_TIME,
            MEMBER_GUBUN,
            HIT,
            IFNULL(CONTENTS_TEXT, '-') CONTENTS_TEXT,
            IFNULL(CONTENTS_IMG, '-') CONTENTS_IMG,
            OPTION1_YN,
            OPTION2_YN,
            OPTION3_YN,
            OPTION4_YN,
            OPTION2_EVENT,
            OPTION2_POPUP,
            (SELECT POPUP_TITLE FROM TB_EVENT_OPTION4 WHERE EVENT_NO = #{searchEventNo} LIMIT 1) AS POPUP_TITLE,
            OPTION2_HIDDEN,
            OPTION_GRADE,
            ONOFF_DIV,
            CASE
                WHEN START_DATE > DATE_FORMAT(NOW(), '%Y%m%d') THEN '대기중'
                WHEN START_DATE <![CDATA[<=]]> DATE_FORMAT(NOW(), '%Y%m%d')
                    AND CONCAT(END_DATE, END_TIME) >= DATE_FORMAT(NOW(), '%Y%m%d%H') THEN '진행중'
                WHEN CONCAT(END_DATE, END_TIME) <![CDATA[<]]> DATE_FORMAT(NOW(), '%Y%m%d%H') THEN '완료'
            END STATUS
        FROM TB_EVENT_INFO
        WHERE EVENT_NO = #{searchEventNo}
    </select>

    <!-- 이벤트 첨부파일 조회 -->
    <select id="eventAttachFile" parameterType="hashMap" resultType="hashMap">
        SELECT *
        FROM TB_EVENT_FILE
        WHERE EVENT_NO = #{EVENT_NO}
        LIMIT 1
    </select>

    <!-- 이벤트 첨부파일 목록 조회 -->
    <select id="eventAttachFileList" parameterType="hashMap" resultType="hashMap">
        SELECT SEQ, EVENT_NO, FILE_PATH, FILE_NAME, REAL_FILE_NAME, DOWN_CNT, DATE_FORMAT(REG_DT, '%Y-%m-%d') REG_DT
        FROM TB_EVENT_FILE
        WHERE EVENT_NO = #{EVENT_NO}
        ORDER BY SEQ
    </select>

    <!-- 이벤트 강좌 목록 조회 -->
    <select id="eventLectureList" parameterType="hashMap" resultType="hashMap">
        SELECT A.SEQ, A.EVENT_NO, A.LECCODE, A.REG_DT,
            B.SUBJECT_TITLE, B.SUBJECT_TEACHER,
            (SELECT USER_NM FROM TB_MA_MEMBER WHERE USER_ID = B.SUBJECT_TEACHER) SUBJECT_TEACHER_NM,
            B.SUBJECT_PRICE, B.SUBJECT_DISCOUNT
        FROM TB_EVENT_LECTURE A
        INNER JOIN TB_LEC_MST B ON A.LECCODE = B.LECCODE
        WHERE A.EVENT_NO = #{EVENT_NO}
        ORDER BY A.SEQ
    </select>

    <!-- 이벤트 강좌 상세 조회 -->
    <select id="eventLectureDetail" parameterType="hashMap" resultType="hashMap">
        SELECT A.SEQ, A.EVENT_NO, A.LECCODE, A.REG_DT,
            B.SUBJECT_TITLE, B.SUBJECT_TEACHER,
            (SELECT USER_NM FROM TB_MA_MEMBER WHERE USER_ID = B.SUBJECT_TEACHER) SUBJECT_TEACHER_NM,
            B.SUBJECT_PRICE, B.SUBJECT_DISCOUNT, B.SUBJECT_DESC, B.SUBJECT_MEMO
        FROM TB_EVENT_LECTURE A
        INNER JOIN TB_LEC_MST B ON A.LECCODE = B.LECCODE
        WHERE A.LECCODE = #{LECCODE}
    </select>

    <!-- 이벤트 조회수 증가 -->
    <update id="updateEventHits" parameterType="hashMap">
        UPDATE TB_EVENT_INFO SET HIT = IFNULL(HIT, 0) + 1 WHERE EVENT_NO = #{searchEventNo}
    </update>

    <!-- 이벤트 옵션1 조회 -->
    <select id="eventDetailOption1" parameterType="hashMap" resultType="hashMap">
        SELECT SEQ, EVENT_NO, OPTION_TITLE, DATE_FORMAT(REG_DT, '%Y-%m-%d') REG_DT
        FROM TB_EVENT_OPTION1
        WHERE EVENT_NO = #{EVENT_NO}
        ORDER BY SEQ
    </select>

    <!-- 이벤트 옵션2 조회 -->
    <select id="eventDetailOption2" parameterType="hashMap" resultType="hashMap">
        SELECT A.SEQ, A.EVENT_NO, A.COMMENT_TEXT,
            DATE_FORMAT(A.REG_DT, '%Y-%m-%d %H:%i:%s') REG_DT,
            A.REG_ID,
            (SELECT USER_NM FROM TB_MA_MEMBER WHERE USER_ID = A.REG_ID) USER_NM,
            (SELECT CONCAT(LEFT(USER_NM, 2), '***') FROM TB_MA_MEMBER WHERE USER_ID = A.REG_ID) USER_NM_MASK
        FROM TB_EVENT_OPTION2 A
        WHERE A.EVENT_NO = #{EVENT_NO}
        ORDER BY A.SEQ DESC
    </select>

    <!-- 이벤트 중복 체크 -->
    <select id="dupCheck" parameterType="hashMap" resultType="String">
        SELECT COUNT(*) CNT
        FROM TB_EVENT_RESULT
        WHERE EVENT_NO = #{EVENT_NO}
            AND USER_ID = #{USER_ID}
    </select>

    <!-- 이벤트 결과 등록 -->
    <insert id="insertEventResult" parameterType="hashMap">
        INSERT INTO TB_EVENT_RESULT (
            EVENT_NO, USER_ID, OPTION1_SEQ, REG_DT
        ) VALUES (
            #{EVENT_NO}, #{USER_ID}, #{OPTION1_SEQ}, NOW()
        )
    </insert>

    <!-- 이벤트 댓글 등록 -->
    <insert id="insertEventComment" parameterType="hashMap">
        INSERT INTO TB_EVENT_OPTION2 (
            EVENT_NO, COMMENT_TEXT, REG_ID, REG_DT
        ) VALUES (
            #{EVENT_NO}, #{COMMENT_TEXT}, #{USER_ID}, NOW()
        )
    </insert>

    <!-- 이벤트 댓글 삭제 -->
    <delete id="deleteEventComment" parameterType="hashMap">
        DELETE FROM TB_EVENT_OPTION2
        WHERE SEQ = #{SEQ}
            AND REG_ID = #{USER_ID}
    </delete>

</mapper>
