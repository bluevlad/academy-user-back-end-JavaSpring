<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.academy.mapper.IndexMapper">

    <!-- 카테고리 목록 조회 -->
    <select id="getCategory" parameterType="hashmap" resultType="hashmap">
        SELECT
            ID,
            CODE,
            NAME,
            ISUSE,
            CASE WHEN ISUSE = 'Y' THEN '활성' ELSE '비활성' END AS ISUSENM,
            DATE_FORMAT(REG_DT, '%Y-%m-%d') AS REG_DT,
            REG_ID,
            DATE_FORMAT(UPD_DT, '%Y-%m-%d') AS UPD_DT,
            UPD_ID
        FROM TB_CATEGORY_INFO
        WHERE ISUSE = 'Y'
          AND P_CODE = 'CLASSCODE'
        <if test='topMenuType != null and topMenuType == "O"'>
            AND USE_ON = 'Y'
        </if>
        <if test='topMenuType != null and topMenuType == "F"'>
            AND USE_OFF = 'Y'
        </if>
        ORDER BY CODE ASC
    </select>

    <!-- 과목 목록 조회 -->
    <select id="getSubjectList" parameterType="hashmap" resultType="hashmap">
        SELECT A.SUBJECT_CD AS VALUE, B.SUBJECT_NM AS TEXT
        FROM TB_SUBJECT_CATEGORY A
        INNER JOIN TB_CATEGORY_SUBJECT_ORDER AA ON A.CATEGORY_CODE = AA.CATEGORY_CODE AND A.SUBJECT_CD = AA.SUBJECT_CD
        INNER JOIN TB_SUBJECT_INFO B ON A.SUBJECT_CD = B.SUBJECT_CD
        WHERE B.ISUSE = 'Y'
        <if test="CATEGORY_CD != null and CATEGORY_CD != ''">
            AND A.CATEGORY_CODE = #{CATEGORY_CD}
        </if>
          AND AA.ONOFF_DIV = 'F'
        ORDER BY AA.IDX
    </select>

    <!-- 강좌 목록 조회 -->
    <select id="getLectureList" parameterType="hashmap" resultType="hashmap">
        SELECT
            LECCODE AS VALUE,
            CONCAT(
                CASE LEC_TYPE_CHOICE
                    WHEN 'D' THEN '단과'
                    WHEN 'J' THEN '종합반'
                    WHEN 'N' THEN '선택형종합반'
                    WHEN 'P' THEN '패키지'
                    ELSE ''
                END,
                ' | ',
                (SELECT USER_NM FROM TB_MA_MEMBER WHERE USER_ID = TB_OFF_LEC_MST.SUBJECT_TEACHER),
                ' | ',
                SUBJECT_TITLE
            ) AS TEXT
        FROM TB_OFF_LEC_MST
        WHERE CATEGORY_CD = #{CATEGORY_CD}
          AND SUBJECT_SJT_CD = #{SUBJECT_SJT_CD}
          AND SUBJECT_ISUSE = 'Y'
    </select>

    <!-- 메인 공지사항 목록 조회 -->
    <select id="getMainNotice" parameterType="hashmap" resultType="hashmap">
        SELECT
            BOARD_SEQ,
            PARENT_BOARD_SEQ,
            SUBJECT,
            DATE_FORMAT(REG_DT, '%Y-%m-%d') AS REG_DT
        FROM TB_BOARD
        WHERE BOARD_MNG_SEQ = #{BOARD_MNG_SEQ}
          AND OPEN_YN = 'Y'
        ORDER BY REG_DT DESC, CAST(BOARD_SEQ AS UNSIGNED) DESC
        LIMIT 5
    </select>

    <!-- 게시판 카테고리 목록 조회 -->
    <select id="boardCateList" parameterType="hashmap" resultType="hashmap">
        SELECT
            (SELECT NAME FROM TB_CATEGORY_INFO WHERE CODE = A.CATEGORY_CODE) AS CODENAME,
            A.CATEGORY_CODE
        FROM TB_BOARD_CATEGORY_INFO A
        WHERE A.BOARD_SEQ = #{BOARD_SEQ}
        ORDER BY A.CATEGORY_CODE ASC
    </select>

    <!-- 메인 추천 공지 목록 조회 -->
    <select id="getMainRecommendNotice" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.*,
            DATE_FORMAT(UPD_DT, '%Y-%m-%d') AS UPD_DT_CHANGE
        FROM TB_BOARD A
        WHERE BOARD_MNG_SEQ = #{BOARD_MNG_SEQ}
          AND A.RECOMMEND = 'Y'
          AND A.OPEN_YN = 'Y'
        ORDER BY CAST(A.BOARD_SEQ AS UNSIGNED) DESC
    </select>

    <!-- 카테고리별 동영상 과목 조회 -->
    <select id="getMovieSubjectByCategory" parameterType="hashmap" resultType="hashmap">
        SELECT G.* FROM (
            SELECT A.SUBJECT_CD, B.SUBJECT_NM, MAX(AA.IDX) AS IDX
            FROM TB_SUBJECT_CATEGORY A
            INNER JOIN TB_CATEGORY_SUBJECT_ORDER AA ON A.CATEGORY_CODE = AA.CATEGORY_CODE AND A.SUBJECT_CD = AA.SUBJECT_CD
            INNER JOIN TB_SUBJECT_INFO B ON A.SUBJECT_CD = B.SUBJECT_CD
            WHERE B.ISUSE = 'Y'
              AND A.CATEGORY_CODE = #{topMenu}
            <if test='topMenuType != null and topMenuType == "O"'>
                AND AA.ONOFF_DIV = 'O'
            </if>
            <if test='topMenuType != null and topMenuType == "F"'>
                AND AA.ONOFF_DIV = 'F'
            </if>
            <if test='SEARCHSERIESCODE != null and SEARCHSERIESCODE != ""'>
                AND B.SUBJECT_CD IN (
                    SELECT SUBJECT_CD FROM TB_SUBJECT_SERIES WHERE SERIES_CD = #{SEARCHSERIESCODE}
                )
            </if>
            GROUP BY A.SUBJECT_CD, B.SUBJECT_NM
        ) G
        ORDER BY G.SUBJECT_CD, G.IDX
    </select>

    <!-- 과목별 동영상 강사 조회 -->
    <select id="getMovieTeacherBySubject" parameterType="hashmap" resultType="hashmap">
        SELECT E.USER_ID, E.USER_NM, A.SUBJECT_CD
        FROM TB_SUBJECT_CATEGORY A
        INNER JOIN TB_CATEGORY_SUBJECT_ORDER AA ON A.CATEGORY_CODE = AA.CATEGORY_CODE AND A.SUBJECT_CD = AA.SUBJECT_CD
        INNER JOIN TB_SUBJECT_INFO B ON A.SUBJECT_CD = B.SUBJECT_CD
        INNER JOIN TB_MA_MEMBER_SUBJECT C ON A.SUBJECT_CD = C.SUBJECT_CD
        INNER JOIN TB_MA_MEMBER_CATEGORY D ON C.USER_ID = D.USER_ID AND A.CATEGORY_CODE = D.CATEGORY_CODE
        INNER JOIN TB_MA_MEMBER E ON C.USER_ID = E.USER_ID
        WHERE B.ISUSE = 'Y'
          AND E.ISUSE = 'Y'
          AND E.USER_ROLE = 'PRF'
          AND E.ON_OPENYN = 'Y'
          AND AA.ONOFF_DIV = 'O'
          AND A.CATEGORY_CODE = #{topMenu}
        GROUP BY E.USER_ID, E.USER_NM, A.SUBJECT_CD
        ORDER BY MIN(AA.IDX), MIN(D.SEQ)
    </select>

    <!-- 시험 D-Day 조회 -->
    <select id="getExamDday" parameterType="hashmap" resultType="hashmap">
        SELECT
            DATE_FORMAT(NOW(), '%Y-%m-%d') AS NOWDATE,
            DDAY_NAME,
            CASE WHEN D_DAY <![CDATA[<]]> 0 THEN 0 ELSE D_DAY END AS D_DAY,
            CHAR_LENGTH(CASE WHEN D_DAY <![CDATA[<]]> 0 THEN '0' ELSE CAST(D_DAY AS CHAR) END) AS D_DAYLENGTH,
            DATE_FORMAT(STR_TO_DATE(DDAY_DATE, '%Y%m%d'), '%Y-%m-%d') AS DDAY_DATE
        FROM (
            SELECT
                A.*,
                DATEDIFF(STR_TO_DATE(A.DDAY_DATE, '%Y%m%d'), CURDATE()) + 1 AS D_DAY
            FROM TB_DDAY A
            WHERE 1 = 1
              AND DDAY_DATE <![CDATA[>]]> DATE_FORMAT(NOW(), '%Y%m%d')
            <if test="topMenu != null and topMenu != '' and topMenu != 'MAIN'">
                AND DDAY_CATEGORY = #{topMenu}
            </if>
        ) T
    </select>

    <!-- 신간 도서 목록 조회 -->
    <select id="getNewBookList" parameterType="hashmap" resultType="hashmap">
        SELECT
            LTBL.*,
            (SELECT NAME FROM TB_CATEGORY_INFO WHERE ISUSE = 'Y' AND CODE = LTBL.CATEGORY_CD) AS CATEGORY_NM,
            (SELECT NAME FROM TB_LEARNING_FORM_INFO WHERE ISUSE = 'Y' AND CODE = LTBL.LEARNING_CD) AS LEARNING_NM,
            (SELECT COUNT(RSC_ID) FROM TB_CA_BOOK WHERE SEQ = LTBL.SEQ AND RSC_ID != LTBL.RSC_ID) AS RELCNT,
            (SELECT COUNT(RSC_ID) FROM TB_PLUS_CA_BOOK WHERE RSC_ID = LTBL.RSC_ID) AS LECCNT
        FROM (
            SELECT T2.*,
                CASE T2.COVER_TYPE
                    WHEN 'A' THEN '주문가능'
                    WHEN 'S' THEN '품절'
                    WHEN 'O' THEN '절판'
                    WHEN 'N' THEN '신규'
                    ELSE ''
                END AS COVER_TYPE_NM
            FROM TB_CA_BOOK T2
            INNER JOIN (
                SELECT MAX(SEQ) AS SEQ,
                       MAX(RSC_ID) AS RSC_ID,
                       SUBJECT_SJT_CD,
                       CATEGORY_CD,
                       LEARNING_CD,
                       BOOK_NM
                FROM TB_CA_BOOK
                WHERE USE_YN = 'Y'
                GROUP BY SUBJECT_SJT_CD, CATEGORY_CD, LEARNING_CD, BOOK_NM
            ) T1 ON T2.SEQ = T1.SEQ AND T2.RSC_ID = T1.RSC_ID
            WHERE T2.COVER_TYPE = 'A'
              AND T2.USE_YN = 'Y'
              AND T2.CATEGORY_CD IN ('001', '002')
              AND IFNULL(T2.BOOK_STUDENTBOOK, 'N') = 'N'
            <if test='BOOKTYPE != null and BOOKTYPE == "NEW"'>
                AND T2.NEW_BOOK = 'Y'
            </if>
            <if test='BOOKTYPE != null and BOOKTYPE == "RECOMMEND"'>
                AND T2.MAIN_VIEW = 'Y'
            </if>
            ORDER BY IFNULL(REG_DT, UPD_DT) DESC
        ) LTBL
        LIMIT 10
    </select>

    <!-- 교수 과목 목록 조회 -->
    <select id="getTeacherSubject" parameterType="hashmap" resultType="hashmap">
        SELECT SUBJECT_CD, SUBJECT_NM, IDX
        FROM (
            SELECT A.SUBJECT_CD, A.SUBJECT_NM, MIN(B.IDX) AS IDX
            FROM TB_SUBJECT_INFO A
            INNER JOIN TB_MAIN_CATEGORY_SUBJECT_ORDER B ON A.SUBJECT_CD = B.SUBJECT_CD
            WHERE A.ISUSE = 'Y'
              AND B.ONOFF_DIV = 'M'
            GROUP BY A.SUBJECT_CD, A.SUBJECT_NM
        ) T
        ORDER BY IDX, SUBJECT_CD
    </select>

    <!-- 교수 과목별 목록 조회 -->
    <select id="getTeacherSubjectList" parameterType="hashmap" resultType="hashmap">
        SELECT C.SUBJECT_CD, C.SUBJECT_NM
        <if test='topMenuType == "O"'>
            FROM TB_MA_MEMBER_INTRO_CATEGORY A
        </if>
        <if test='topMenuType == "F"'>
            FROM TB_MA_MEMBER_INTRO_F_CATEGORY A
        </if>
        INNER JOIN TB_MA_MEMBER B ON A.USER_ID = B.USER_ID
        INNER JOIN TB_SUBJECT_INFO C ON A.SUBJECT_CD = C.SUBJECT_CD
        INNER JOIN TB_INTR_CATEGORY_SUBJECT_ORDER D ON C.SUBJECT_CD = D.SUBJECT_CD
        WHERE D.ONOFF_DIV = 'I'
          AND C.ISUSE = 'Y'
          AND B.ISUSE = 'Y'
          AND OFF_OPENYN = 'Y'
        GROUP BY C.SUBJECT_CD, C.SUBJECT_NM
        ORDER BY MIN(D.IDX), C.SUBJECT_CD
    </select>

    <!-- 교수 목록 조회 -->
    <select id="getTeacherList" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.USER_ID,
            B.USER_NM,
            B.ISUSE,
            B.EMAIL,
            B.PHONE_NO,
            CASE WHEN B.ISUSE = 'Y' THEN '공개' ELSE '비공개' END AS ISUSENM,
            DATE_FORMAT(B.REG_DT, '%Y-%m-%d') AS REG_DT,
            B.BIRTH_DAY,
            B.ON_OPENYN,
            B.OFF_OPENYN,
            CASE WHEN IFNULL(ON_OPENYN, 'Y') = 'Y' THEN '활성' ELSE '비활성' END AS ON_OPENYNNM,
            CASE WHEN IFNULL(OFF_OPENYN, 'Y') = 'Y' THEN '활성' ELSE '비활성' END AS OFF_OPENYNNM,
            A.SUBJECT_CD,
            C.SUBJECT_NM,
            A.CATEGORY_CODE AS CATEGORY_CD,
            A.SEQ,
            B.OFF_PIC1,
            B.PRF_ONPIC2,
            B.PRF_OFFPIC2,
            B.OFF_TITLE,
            (SELECT MIN(CATEGORY_CODE) FROM TB_SUBJECT_CATEGORY WHERE SUBJECT_CD = C.SUBJECT_CD) AS CATEGORY_CODE
        FROM TB_MA_MEMBER_MAIN_CATEGORY A
        INNER JOIN TB_MA_MEMBER B ON A.USER_ID = B.USER_ID
        INNER JOIN TB_SUBJECT_INFO C ON A.SUBJECT_CD = C.SUBJECT_CD
        INNER JOIN TB_MAIN_CATEGORY_SUBJECT_ORDER D ON C.SUBJECT_CD = D.SUBJECT_CD
        WHERE D.ONOFF_DIV = 'M'
          AND C.ISUSE = 'Y'
          AND B.ISUSE = 'Y'
          AND OFF_OPENYN = 'Y'
        GROUP BY A.USER_ID, B.USER_NM, B.ISUSE, B.EMAIL, B.PHONE_NO, B.REG_DT, B.BIRTH_DAY,
                 B.ON_OPENYN, B.OFF_OPENYN, A.SUBJECT_CD, C.SUBJECT_NM, A.SEQ,
                 D.SUBJECT_CD, A.CATEGORY_CODE, C.SUBJECT_CD, B.OFF_PIC1,
                 B.PRF_ONPIC2, B.PRF_OFFPIC2, B.OFF_TITLE
        ORDER BY MIN(D.IDX), C.SUBJECT_CD, A.SEQ
    </select>

    <!-- 빠른 교수 목록 조회 -->
    <select id="getQuickTeacherList" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.USER_ID,
            B.USER_NM,
            B.ISUSE,
            B.EMAIL,
            B.PHONE_NO,
            CASE WHEN B.ISUSE = 'Y' THEN '공개' ELSE '비공개' END AS ISUSENM,
            DATE_FORMAT(B.REG_DT, '%Y-%m-%d') AS REG_DT,
            B.BIRTH_DAY,
            B.ON_OPENYN,
            B.OFF_OPENYN,
            CASE WHEN IFNULL(ON_OPENYN, 'Y') = 'Y' THEN '활성' ELSE '비활성' END AS ON_OPENYNNM,
            CASE WHEN IFNULL(OFF_OPENYN, 'Y') = 'Y' THEN '활성' ELSE '비활성' END AS OFF_OPENYNNM,
            A.SUBJECT_CD,
            C.SUBJECT_NM,
            A.CATEGORY_CODE AS CATEGORY_CD,
            A.SEQ,
            B.OFF_PIC1,
            B.PRF_ONPIC2,
            B.PRF_OFFPIC2,
            B.OFF_TITLE,
            (SELECT MIN(CATEGORY_CODE) FROM TB_SUBJECT_CATEGORY WHERE SUBJECT_CD = C.SUBJECT_CD) AS CATEGORY_CODE
        <if test='topMenuType == "O"'>
            FROM TB_MA_MEMBER_INTRO_CATEGORY A
        </if>
        <if test='topMenuType == "F"'>
            FROM TB_MA_MEMBER_INTRO_F_CATEGORY A
        </if>
        INNER JOIN TB_MA_MEMBER B ON A.USER_ID = B.USER_ID
        INNER JOIN TB_SUBJECT_INFO C ON A.SUBJECT_CD = C.SUBJECT_CD
        INNER JOIN TB_INTR_CATEGORY_SUBJECT_ORDER D ON C.SUBJECT_CD = D.SUBJECT_CD
        WHERE D.ONOFF_DIV = 'I'
          AND C.ISUSE = 'Y'
          AND B.ISUSE = 'Y'
          AND OFF_OPENYN = 'Y'
        GROUP BY A.USER_ID, B.USER_NM, B.ISUSE, B.EMAIL, B.PHONE_NO, B.REG_DT, B.BIRTH_DAY,
                 B.ON_OPENYN, B.OFF_OPENYN, A.SUBJECT_CD, C.SUBJECT_NM, A.SEQ,
                 D.SUBJECT_CD, A.CATEGORY_CODE, C.SUBJECT_CD, B.OFF_PIC1,
                 B.PRF_ONPIC2, B.PRF_OFFPIC2, B.OFF_TITLE
        ORDER BY MIN(D.IDX), C.SUBJECT_CD, A.SEQ
    </select>

    <!-- 이슈 목록 조회 -->
    <select id="getIssueList" parameterType="hashmap" resultType="hashmap">
        SELECT * FROM (
            SELECT
                'EVENT' AS TYPE,
                TITLE,
                EVENT_NO AS SEQ,
                ISSUE_THUMBNAIL AS FILE_PATH,
                OPTION1_YN AS OPTION_YN,
                REG_DT
            FROM TB_EVENT_INFO
            WHERE ONOFF_DIV = 'F'
              AND NOTICE_GUBUN LIKE '%2%'
              AND CATEGORY_CODE = #{topMenu}
              AND OPEN_YN = 'Y'

            UNION ALL

            SELECT
                'NOTICE' AS TYPE,
                BB.SUBJECT AS TITLE,
                BB.BOARD_SEQ AS SEQ,
                BB.THUMBNAIL_FILE_PATH AS FILE_PATH,
                'N' AS OPTION_YN,
                BB.REG_DT
            FROM TB_BOARD_CATEGORY_INFO AA
            INNER JOIN TB_BOARD BB ON AA.BOARD_MNG_SEQ = BB.BOARD_MNG_SEQ AND AA.BOARD_SEQ = BB.BOARD_SEQ
            INNER JOIN TB_BOARD_MNG CC ON CC.BOARD_MNG_SEQ = AA.BOARD_MNG_SEQ
            WHERE AA.CATEGORY_CODE = #{topMenu}
              AND BB.OPEN_YN = 'Y'
              AND BB.ISSUE = 'Y'
              AND AA.BOARD_MNG_SEQ = 'NOTICE_000'
        ) T
        ORDER BY REG_DT DESC
    </select>

    <!-- 서브메인 강좌 목록 조회 -->
    <select id="getSubMainLectureList" parameterType="hashmap" resultType="hashmap">
        SELECT TBL.* FROM (
            SELECT
                T1.BRIDGE_LECCODE,
                T2.*,
                (SELECT OFF_PIC1 FROM TB_MA_MEMBER WHERE USER_ID = T2.SUBJECT_TEACHER) AS TEACHER_OFF_PIC1,
                (SELECT NAME FROM TB_CATEGORY_INFO WHERE CODE = T2.CATEGORY_CD) AS CATEGORY_NM,
                (SELECT NAME FROM TB_LEARNING_FORM_INFO WHERE CODE = T2.LEARNING_CD) AS LEARNING_NM,
                (SELECT SUBJECT_NM FROM TB_SUBJECT_INFO WHERE SUBJECT_CD = T2.SUBJECT_SJT_CD) AS SUBJECT_NM,
                (SELECT USER_NM FROM TB_MA_MEMBER WHERE USER_ID = T2.SUBJECT_TEACHER) AS SUBJECT_TEACHER_NM,
                IFNULL((SELECT MIN(DATE_FORMAT(Z.LEC_DATE, '%Y-%m-%d')) FROM TB_OFF_LECTURE_DATE Z WHERE Z.LECCODE = T2.LECCODE), '') AS MIN_DATE,
                IFNULL((SELECT MAX(DATE_FORMAT(Z.LEC_DATE, '%Y-%m-%d')) FROM TB_OFF_LECTURE_DATE Z WHERE Z.LECCODE = T2.LECCODE), '') AS MAX_DATE,
                DATE_FORMAT(NOW(), '%Y-%m-%d') AS CURDATE
            FROM TB_OFF_LEC_BRIDGE T1
            INNER JOIN TB_OFF_LEC_MST T2 ON T1.LECCODE = T2.LECCODE
            WHERE (SELECT MAX(Z.LEC_DATE) FROM TB_OFF_LECTURE_DATE Z WHERE Z.LECCODE = T2.LECCODE) >= NOW()
        ) TBL
        WHERE TBL.LEC_TYPE_CHOICE = 'D'
          AND TBL.SUBJECT_ISUSE = 'Y'
          AND TBL.CATEGORY_CD = #{topMenu}
        <if test='SUBLECTYPE != null and SUBLECTYPE == "DAN"'>
            AND TBL.LEARNING_CD = 'M0101'
        </if>
        <if test='SUBLECTYPE != null and SUBLECTYPE == "MUN"'>
            AND TBL.LEARNING_CD = 'M0102'
        </if>
        <if test='SUBLECTYPE != null and SUBLECTYPE == "REC"'>
            AND TBL.REC_GUBUN = 'Y'
        </if>
        <if test='SUBLECTYPE != null and SUBLECTYPE == "NEW"'>
            AND TBL.LEC_GUBUN = 'Y'
        </if>
        ORDER BY TBL.CATEGORY_CD, TBL.LEARNING_CD, TBL.SUBJECT_SJT_CD, TBL.SEQ DESC
    </select>

    <!-- 팝업 목록 조회 -->
    <select id="getPopupList" parameterType="hashmap" resultType="hashmap">
        SELECT *
        FROM TB_POPUP_INFO
        WHERE OPEN_YN = 'Y'
          AND STR_TO_DATE(CONCAT(START_DATE, START_TIME), '%Y%m%d%H') <![CDATA[<=]]> NOW()
          AND STR_TO_DATE(CONCAT(END_DATE, END_TIME), '%Y%m%d%H') <![CDATA[>=]]> NOW()
          AND ONOFF_DIV = #{topMenuType}
          AND CATEGORY_CODE LIKE CONCAT('%', #{topMenu}, '%')
        ORDER BY REG_DT ASC
    </select>

    <!-- 팝업 조회수 증가 -->
    <update id="updatePopupViewCount" parameterType="hashmap">
        UPDATE TB_POPUP_INFO
        SET HIT = HIT + 1
        WHERE NO = #{SEQ}
    </update>

    <!-- 배너 목록 조회 (간소화) -->
    <select id="getBannerList" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.BANNER_NO,
            A.BANNER_TITLE,
            A.BANNER_TYP,
            A.CATEGORY_CD AS CAT_CD,
            B.SEQ,
            B.ROL_IDX,
            B.CLICK_CNT,
            B.BANNER_NOTE,
            B.BANNER_LINK_TARGET,
            B.BANNER_SUBTITLE,
            B.BANNER_IMAGE,
            B.BANNER_THUMBNAIL_IMAGE,
            B.BANNER_LINK,
            DATE_FORMAT(B.REG_DT, '%Y-%m-%d') AS REG_DT
        FROM TB_BANNER A
        INNER JOIN TB_BANNER_ITEM B ON A.SEQ = B.P_SEQ
        WHERE A.ISUSE = 'Y'
          AND B.ISUSE = 'Y'
          AND A.ONOFF_DIV = #{topMenuType}
          AND A.SCREEN_GUBUN = #{SCREEN_GUBUN}
          AND DATE_FORMAT(B.BANNER_SDT, '%Y-%m-%d') <![CDATA[<=]]> DATE_FORMAT(NOW(), '%Y-%m-%d')
          AND DATE_FORMAT(B.BANNER_EDT, '%Y-%m-%d') <![CDATA[>=]]> DATE_FORMAT(NOW(), '%Y-%m-%d')
        <if test='SCREEN_GUBUN != null and SCREEN_GUBUN == "M" and CATEGORY_CD != null and CATEGORY_CD != ""'>
            AND A.CATEGORY_CD = #{CATEGORY_CD}
        </if>
        <if test='SCREEN_GUBUN != null and SCREEN_GUBUN == "H" and CATEGORY_CD != null and CATEGORY_CD != ""'>
            AND A.CATEGORY_CD = #{CATEGORY_CD}
        </if>
        <if test='SCREEN_GUBUN != null and SCREEN_GUBUN == "M" and topMenu != "MAIN"'>
            AND A.CATEGORY_CD = #{topMenu}
        </if>
        <if test='SCREEN_GUBUN != null and SCREEN_GUBUN == "S" and topMenu != null and topMenu != ""'>
            AND A.CATEGORY_CD = #{topMenu}
        </if>
        <if test='BANNER_NO != null and BANNER_NO != ""'>
            AND A.BANNER_NO = #{BANNER_NO}
        </if>
        ORDER BY B.ROL_IDX ASC, B.REG_DT DESC
    </select>

    <!-- 배너 클릭수 증가 -->
    <update id="updateBannerViewCount" parameterType="hashmap">
        UPDATE TB_BANNER_ITEM
        SET CLICK_CNT = CLICK_CNT + 1
        WHERE SEQ = #{SEQ}
    </update>

</mapper>
