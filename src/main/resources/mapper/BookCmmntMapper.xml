<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.academy.mapper.BookCmmntMapper">

    <!-- 도서 후기 목록 조회 -->
    <select id="selectBookCmmt" parameterType="hashmap" resultType="hashmap">
        SELECT
            AA.BOOK_AUTHOR,
            AA.CATEGORY_CD,
            AA.LEARNING_CD,
            AA.SUBJECT_SJT_CD,
            AA.BOOK_NM,
            AA.RSC_ID,
            AA.SEQ,
            AA.USER_ID,
            AA.USER_NAME,
            AA.TITLE,
            AA.CONTENT,
            AA.CHOICE_POINT,
            AA.REG_DT
        FROM (
            SELECT
                a.BOOK_AUTHOR,
                a.CATEGORY_CD,
                a.LEARNING_CD,
                a.SUBJECT_SJT_CD,
                a.BOOK_NM,
                b.RSC_ID,
                b.SEQ,
                b.USER_ID,
                CONCAT(LEFT(b.USER_NAME, LENGTH(b.USER_NAME)-1), '*') AS USER_NAME,
                b.TITLE,
                b.CONTENT,
                b.CHOICE_POINT,
                DATE_FORMAT(b.REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT
            FROM TB_CA_BOOK a, TB_COMMENT_BOOK b
            WHERE a.RSC_ID = b.RSC_ID
              AND a.CATEGORY_CD = #{topMenu}
              AND a.USE_YN = 'Y'
        ) AA
        WHERE 1=1
        <if test="SEARCHSUBJECT != null and SEARCHSUBJECT != ''">
            AND AA.SUBJECT_SJT_CD = #{SEARCHSUBJECT}
        </if>
        <if test="SEARCHTEAC != null and SEARCHTEAC != ''">
            AND AA.BOOK_AUTHOR = #{SEARCHTEAC}
        </if>
        ORDER BY AA.CHOICE_POINT DESC, AA.SEQ DESC, AA.RSC_ID DESC
        LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>

    <!-- 도서 후기 목록 수 조회 -->
    <select id="getBookCmmtCount" parameterType="hashmap" resultType="int">
        SELECT COUNT(*) AS CNT
        FROM (
            SELECT
                a.BOOK_AUTHOR,
                a.SUBJECT_SJT_CD,
                a.BOOK_NM,
                b.RSC_ID,
                b.SEQ,
                b.USER_ID,
                b.USER_NAME,
                b.TITLE,
                b.CONTENT,
                b.CHOICE_POINT,
                b.REG_DT
            FROM TB_CA_BOOK a, TB_COMMENT_BOOK b
            WHERE a.RSC_ID = b.RSC_ID
              AND a.CATEGORY_CD = #{topMenu}
              AND a.USE_YN = 'Y'
        ) AA
        WHERE 1=1
        <if test="SEARCHSUBJECT != null and SEARCHSUBJECT != ''">
            AND AA.SUBJECT_SJT_CD = #{SEARCHSUBJECT}
        </if>
        <if test="SEARCHTEAC != null and SEARCHTEAC != ''">
            AND AA.BOOK_AUTHOR = #{SEARCHTEAC}
        </if>
    </select>

    <!-- 도서 구매 여부 확인 -->
    <select id="isBookCmmt" parameterType="hashmap" resultType="int">
        SELECT COUNT(*) AS CNT
        FROM TB_ORDERS a, TB_ORDER_MGNT_NO b
        WHERE a.ORDERNO = b.ORDERNO
          AND a.USER_ID = #{USER_ID}
          AND b.MGNTNO = #{RSC_ID}
    </select>

    <!-- 사용자별 도서 후기 수 조회 -->
    <select id="getBookCmmtCntByUser" parameterType="hashmap" resultType="int">
        SELECT COUNT(*) AS CNT
        FROM TB_CA_BOOK a, TB_COMMENT_BOOK b
        WHERE a.RSC_ID = b.RSC_ID
          AND a.RSC_ID = #{RSC_ID}
          AND b.USER_ID = #{USER_ID}
    </select>

    <!-- 도서 상세 후기 목록 조회 -->
    <select id="detailCmmtList" parameterType="hashmap" resultType="hashmap">
        SELECT
            a.BOOK_NM,
            a.CATEGORY_CD,
            a.LEARNING_CD,
            a.SUBJECT_SJT_CD,
            b.RSC_ID,
            b.SEQ,
            CONCAT(LEFT(b.USER_NAME, LENGTH(b.USER_NAME)-1), '*') AS USER_NAME,
            b.USER_ID,
            b.USER_NAME AS USER_NAME_ORI,
            b.TITLE,
            b.CONTENT,
            b.CHOICE_POINT,
            DATE_FORMAT(b.REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT
        FROM TB_CA_BOOK a, TB_COMMENT_BOOK b
        WHERE a.RSC_ID = b.RSC_ID
          AND a.CATEGORY_CD = #{topMenu}
          AND b.RSC_ID = #{RSC_ID}
          AND a.USE_YN = 'Y'
        ORDER BY b.RSC_ID DESC, b.SEQ DESC
        LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>

    <!-- 도서 상세 후기 목록 수 조회 -->
    <select id="detailCmmtListCount" parameterType="hashmap" resultType="int">
        SELECT COUNT(*) AS CNT
        FROM TB_CA_BOOK a, TB_COMMENT_BOOK b
        WHERE a.RSC_ID = b.RSC_ID
          AND a.CATEGORY_CD = #{topMenu}
          AND b.RSC_ID = #{RSC_ID}
          AND a.USE_YN = 'Y'
    </select>

    <!-- 도서 후기 등록 -->
    <insert id="insertCmmt" parameterType="hashmap">
        <selectKey keyProperty="SEQ" resultType="int" order="BEFORE">
            SELECT IFNULL(MAX(CAST(SEQ AS UNSIGNED)), 0) + 1 FROM TB_COMMENT_BOOK
        </selectKey>
        INSERT INTO TB_COMMENT_BOOK (
            SEQ,
            RSC_ID,
            USER_ID,
            USER_NAME,
            TITLE,
            CONTENT,
            CHOICE_POINT,
            REG_DT
        ) VALUES (
            #{SEQ},
            #{RSC_ID},
            #{USER_ID},
            #{USER_NM},
            #{TITLE},
            #{CONTENT},
            #{CHOICE_POINT},
            NOW()
        )
    </insert>

    <!-- 도서 후기 삭제 -->
    <delete id="deleteCmmt" parameterType="hashmap">
        DELETE FROM TB_COMMENT_BOOK
        WHERE SEQ = #{DELETE_SEQ}
    </delete>

</mapper>
