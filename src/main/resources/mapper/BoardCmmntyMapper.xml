<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.academy.mapper.BoardCmmntyMapper">

    <!-- 게시판 정보 조회 -->
    <select id="getBoardInfo" parameterType="hashmap" resultType="hashmap">
        SELECT
            BOARD_MNG_SEQ,
            BOARD_NM,
            BOARD_DESC,
            USE_YN
        FROM TB_BOARD_MNG
        WHERE BOARD_MNG_SEQ = #{BOARD_MNG_SEQ}
    </select>

    <!-- 커뮤니티 게시판 목록 조회 -->
    <select id="boardList" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.BOARD_SEQ,
            A.BOARD_MNG_SEQ,
            A.SUBJECT,
            A.CONTENT,
            A.HITS,
            A.REG_ID,
            A.REG_NM,
            DATE_FORMAT(A.REG_DT, '%Y-%m-%d') AS REG_DT,
            A.OPEN_YN,
            A.COMMNTY_GUBN,
            IFNULL(A.VOTINGY_CNT, 0) AS VOTINGY_CNT,
            (SELECT COUNT(*) FROM TB_BOARD_COMMENT WHERE BOARD_SEQ = A.BOARD_SEQ AND DEL_YN = 'N') AS COMMENT_CNT
        FROM TB_BOARD A
        WHERE A.BOARD_MNG_SEQ = #{BOARD_MNG_SEQ}
          AND A.DEL_YN = 'N'
        <if test="SEARCHTEXT != null and SEARCHTEXT != ''">
            <choose>
                <when test="SEARCHKIND == 'subject'">
                    AND A.SUBJECT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <when test="SEARCHKIND == 'content'">
                    AND A.CONTENT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <when test="SEARCHKIND == 'regNm'">
                    AND A.REG_NM LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <otherwise>
                    AND (A.SUBJECT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                         OR A.CONTENT LIKE CONCAT('%', #{SEARCHTEXT}, '%'))
                </otherwise>
            </choose>
        </if>
        <if test="SCH_COMMNTY_GUBN != null and SCH_COMMNTY_GUBN != ''">
            AND A.COMMNTY_GUBN = #{SCH_COMMNTY_GUBN}
        </if>
        <if test="MOCKCODE != null and MOCKCODE != ''">
            AND A.MOCKCODE = #{MOCKCODE}
        </if>
        ORDER BY A.NOTICE_TOP_YN DESC, A.REG_DT DESC, A.BOARD_SEQ DESC
        LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>

    <!-- 커뮤니티 게시판 목록 수 조회 -->
    <select id="boardListCount" parameterType="hashmap" resultType="int">
        SELECT COUNT(*)
        FROM TB_BOARD A
        WHERE A.BOARD_MNG_SEQ = #{BOARD_MNG_SEQ}
          AND A.DEL_YN = 'N'
        <if test="SEARCHTEXT != null and SEARCHTEXT != ''">
            <choose>
                <when test="SEARCHKIND == 'subject'">
                    AND A.SUBJECT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <when test="SEARCHKIND == 'content'">
                    AND A.CONTENT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <when test="SEARCHKIND == 'regNm'">
                    AND A.REG_NM LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <otherwise>
                    AND (A.SUBJECT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                         OR A.CONTENT LIKE CONCAT('%', #{SEARCHTEXT}, '%'))
                </otherwise>
            </choose>
        </if>
        <if test="SCH_COMMNTY_GUBN != null and SCH_COMMNTY_GUBN != ''">
            AND A.COMMNTY_GUBN = #{SCH_COMMNTY_GUBN}
        </if>
        <if test="MOCKCODE != null and MOCKCODE != ''">
            AND A.MOCKCODE = #{MOCKCODE}
        </if>
    </select>

    <!-- BEST 게시물 목록 조회 -->
    <select id="boardBestList" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.BOARD_SEQ,
            A.BOARD_MNG_SEQ,
            A.SUBJECT,
            A.HITS,
            A.REG_NM,
            DATE_FORMAT(A.REG_DT, '%Y-%m-%d') AS REG_DT,
            IFNULL(A.VOTINGY_CNT, 0) AS VOTINGY_CNT
        FROM TB_BOARD A
        WHERE A.BOARD_MNG_SEQ = #{BOARD_MNG_SEQ}
          AND A.DEL_YN = 'N'
          AND A.OPEN_YN = 'Y'
        ORDER BY A.VOTINGY_CNT DESC, A.HITS DESC
        LIMIT #{endNo} OFFSET #{startNo}
    </select>

    <!-- 게시물 상세 조회 -->
    <select id="boardView" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.BOARD_SEQ,
            A.BOARD_MNG_SEQ,
            A.SUBJECT,
            A.CONTENT,
            A.HITS,
            A.REG_ID,
            A.REG_NM,
            DATE_FORMAT(A.REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT,
            A.UPD_ID,
            DATE_FORMAT(A.UPD_DT, '%Y-%m-%d %H:%i:%s') AS UPD_DT,
            A.OPEN_YN,
            A.COMMNTY_GUBN,
            IFNULL(A.VOTINGY_CNT, 0) AS VOTINGY_CNT,
            A.MOCKCODE
        FROM TB_BOARD A
        WHERE A.BOARD_SEQ = #{BOARD_SEQ}
          AND A.DEL_YN = 'N'
    </select>

    <!-- 게시물 첨부파일 조회 -->
    <select id="boardAttachFile" parameterType="hashmap" resultType="hashmap">
        SELECT
            FILE_SEQ,
            BOARD_SEQ,
            FILE_PATH,
            FILE_NAME,
            REAL_FILE_NAME,
            FILE_SIZE,
            DATE_FORMAT(REG_DT, '%Y-%m-%d') AS REG_DT
        FROM TB_BOARD_FILE
        WHERE BOARD_SEQ = #{BOARD_SEQ}
          AND FILE_TYPE = 'F'
          AND DEL_YN = 'N'
        ORDER BY FILE_SEQ
    </select>

    <!-- 게시물 이미지 첨부파일 조회 -->
    <select id="boardAttachFileImg" parameterType="hashmap" resultType="hashmap">
        SELECT
            FILE_SEQ,
            BOARD_SEQ,
            FILE_PATH,
            FILE_NAME,
            REAL_FILE_NAME,
            FILE_SIZE,
            DATE_FORMAT(REG_DT, '%Y-%m-%d') AS REG_DT
        FROM TB_BOARD_FILE
        WHERE BOARD_SEQ = #{BOARD_SEQ}
          AND FILE_TYPE = 'I'
          AND DEL_YN = 'N'
        ORDER BY FILE_SEQ
    </select>

    <!-- 조회수 증가 -->
    <update id="updateBoardHits" parameterType="hashmap">
        UPDATE TB_BOARD
        SET HITS = IFNULL(HITS, 0) + 1
        WHERE BOARD_SEQ = #{BOARD_SEQ}
    </update>

    <!-- 게시물 등록 -->
    <insert id="insertBoard" parameterType="hashmap">
        <selectKey keyProperty="BOARD_SEQ" resultType="string" order="BEFORE">
            SELECT IFNULL(MAX(CAST(BOARD_SEQ AS UNSIGNED)), 0) + 1 FROM TB_BOARD
        </selectKey>
        INSERT INTO TB_BOARD (
            BOARD_SEQ,
            BOARD_MNG_SEQ,
            SUBJECT,
            CONTENT,
            HITS,
            REG_ID,
            REG_NM,
            REG_DT,
            OPEN_YN,
            DEL_YN,
            NOTICE_TOP_YN,
            COMMNTY_GUBN,
            MOCKCODE,
            VOTINGY_CNT
        ) VALUES (
            #{BOARD_SEQ},
            #{BOARD_MNG_SEQ},
            #{SUBJECT},
            #{CONTENT},
            0,
            #{REG_ID},
            #{USER_NM},
            NOW(),
            #{OPEN_YN},
            'N',
            #{NOTICE_TOP_YN},
            #{COMMNTY_GUBN},
            #{MOCKCODE},
            0
        )
    </insert>

    <!-- 게시물 수정 -->
    <update id="updateBoard" parameterType="hashmap">
        UPDATE TB_BOARD
        SET
            SUBJECT = #{SUBJECT},
            CONTENT = #{CONTENT},
            OPEN_YN = #{OPEN_YN},
            COMMNTY_GUBN = #{COMMNTY_GUBN},
            UPD_ID = #{UPD_ID},
            UPD_DT = NOW()
        WHERE BOARD_SEQ = #{BOARD_SEQ}
    </update>

    <!-- 게시물 삭제 -->
    <update id="deleteBoard" parameterType="hashmap">
        UPDATE TB_BOARD
        SET
            DEL_YN = 'Y',
            UPD_ID = #{UPD_ID},
            UPD_DT = NOW()
        WHERE BOARD_SEQ = #{BOARD_SEQ}
    </update>

    <!-- 추천 등록 -->
    <insert id="insertRecommnd" parameterType="hashmap">
        INSERT INTO TB_BOARD_VOTING (
            BOARD_SEQ,
            USER_ID,
            VOTING,
            ISTYPE,
            REG_DT
        ) VALUES (
            #{BOARD_SEQ},
            #{USER_ID},
            #{VOTING},
            #{ISTYPE},
            NOW()
        )
        ON DUPLICATE KEY UPDATE
            VOTING = #{VOTING},
            REG_DT = NOW()
    </insert>

    <!-- 추천 수 조회 (업데이트 후) -->
    <select id="getRecommndCount" parameterType="hashmap" resultType="string">
        SELECT COUNT(*) AS VOTINGY_CNT
        FROM TB_BOARD_VOTING
        WHERE BOARD_SEQ = #{BOARD_SEQ}
          AND VOTING = 'Y'
          AND ISTYPE = 'R'
    </select>

    <!-- 댓글 목록 조회 -->
    <select id="getCommentList" parameterType="hashmap" resultType="hashmap">
        SELECT
            COMMENT_SEQ,
            BOARD_SEQ,
            CONTENT,
            REG_ID,
            REG_NM,
            DATE_FORMAT(REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT
        FROM TB_BOARD_COMMENT
        WHERE BOARD_SEQ = #{BOARD_SEQ}
          AND DEL_YN = 'N'
        ORDER BY REG_DT ASC
    </select>

    <!-- 댓글 수 조회 -->
    <select id="getCommentCount" parameterType="hashmap" resultType="int">
        SELECT COUNT(*)
        FROM TB_BOARD_COMMENT
        WHERE BOARD_SEQ = #{BOARD_SEQ}
          AND DEL_YN = 'N'
    </select>

    <!-- 댓글 등록 -->
    <insert id="insertComment" parameterType="hashmap">
        INSERT INTO TB_BOARD_COMMENT (
            BOARD_SEQ,
            CONTENT,
            REG_ID,
            REG_NM,
            REG_DT,
            DEL_YN
        ) VALUES (
            #{BOARD_SEQ},
            #{CONTENT},
            #{REG_ID},
            #{USER_NM},
            NOW(),
            'N'
        )
    </insert>

    <!-- 댓글 삭제 -->
    <update id="deleteComment" parameterType="hashmap">
        UPDATE TB_BOARD_COMMENT
        SET DEL_YN = 'Y'
        WHERE COMMENT_SEQ = #{COMMENT_SEQ}
    </update>

</mapper>
