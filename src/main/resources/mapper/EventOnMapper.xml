<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.academy.mapper.EventOnMapper">

    <!-- 온라인 이벤트 목록 조회 -->
    <select id="onEventList" parameterType="hashmap" resultType="hashmap">
        SELECT
            EVENT_NO,
            LIST_THUMBNAIL,
            TITLE,
            DATE_FORMAT(STR_TO_DATE(START_DATE, '%Y%m%d'), '%Y-%m-%d') AS START_DATE,
            START_TIME,
            DATE_FORMAT(STR_TO_DATE(END_DATE, '%Y%m%d'), '%Y-%m-%d') AS END_DATE,
            END_TIME,
            IFNULL(HIT, 0) AS HIT,
            (SELECT COUNT(*) FROM TB_EVENT_FILE WHERE EVENT_NO = T.EVENT_NO) AS ATTACH_FILE_CNT,
            (SELECT COUNT(*) FROM TB_EVENT_OPTION2 WHERE EVENT_NO = T.EVENT_NO) AS COMMENT_CNT,
            DATE_FORMAT(REG_DT, '%Y-%m-%d') AS REG_DT,
            CASE
                WHEN START_DATE > DATE_FORMAT(NOW(), '%Y%m%d') THEN '대기중'
                WHEN START_DATE <![CDATA[<=]]> DATE_FORMAT(NOW(), '%Y%m%d')
                    AND CONCAT(END_DATE, END_TIME) >= DATE_FORMAT(NOW(), '%Y%m%d%H') THEN '진행중'
                WHEN CONCAT(END_DATE, END_TIME) <![CDATA[<]]> DATE_FORMAT(NOW(), '%Y%m%d%H') THEN '완료'
            END AS STATUS,
            (SELECT M.USER_NM FROM TB_MA_MEMBER M WHERE M.USER_ID = T.REG_ID) AS CREATENAME
        FROM TB_EVENT_INFO T
        WHERE OPEN_YN = 'Y'
          AND ONOFF_DIV = 'L'
        <if test="SEARCHTEXT != null and SEARCHTEXT != ''">
            <choose>
                <when test='SEARCHKIND == "SEARCHSUBJECT"'>
                    AND TITLE LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <when test='SEARCHKIND == "SEARCHCONTENT"'>
                    AND CONTENTS_TEXT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <otherwise>
                    AND (TITLE LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                        OR CONTENTS_TEXT LIKE CONCAT('%', #{SEARCHTEXT}, '%'))
                </otherwise>
            </choose>
        </if>
        <if test='SEARCHINGLIST != null and SEARCHINGLIST == "Y"'>
            AND START_DATE <![CDATA[<=]]> DATE_FORMAT(NOW(), '%Y%m%d')
            AND CONCAT(END_DATE, END_TIME) >= DATE_FORMAT(NOW(), '%Y%m%d%H')
        </if>
        ORDER BY REG_DT DESC, END_DATE DESC, CAST(EVENT_NO AS UNSIGNED) DESC
        LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>

    <!-- 온라인 이벤트 건수 조회 -->
    <select id="onEventListCount" parameterType="hashmap" resultType="int">
        SELECT COUNT(*)
        FROM TB_EVENT_INFO T
        WHERE OPEN_YN = 'Y'
          AND ONOFF_DIV = 'L'
        <if test="SEARCHTEXT != null and SEARCHTEXT != ''">
            <choose>
                <when test='SEARCHKIND == "SEARCHSUBJECT"'>
                    AND TITLE LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <when test='SEARCHKIND == "SEARCHCONTENT"'>
                    AND CONTENTS_TEXT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <otherwise>
                    AND (TITLE LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                        OR CONTENTS_TEXT LIKE CONCAT('%', #{SEARCHTEXT}, '%'))
                </otherwise>
            </choose>
        </if>
        <if test='SEARCHINGLIST != null and SEARCHINGLIST == "Y"'>
            AND START_DATE <![CDATA[<=]]> DATE_FORMAT(NOW(), '%Y%m%d')
            AND CONCAT(END_DATE, END_TIME) >= DATE_FORMAT(NOW(), '%Y%m%d%H')
        </if>
    </select>

    <!-- 온라인 이벤트 상세 조회 -->
    <select id="onEventDetail" parameterType="hashmap" resultType="hashmap">
        SELECT
            EVENT_NO,
            TITLE,
            DATE_FORMAT(REG_DT, '%Y-%m-%d') AS REG_DT,
            DATE_FORMAT(STR_TO_DATE(START_DATE, '%Y%m%d'), '%Y-%m-%d') AS START_DATE,
            START_TIME,
            DATE_FORMAT(STR_TO_DATE(END_DATE, '%Y%m%d'), '%Y-%m-%d') AS END_DATE,
            END_TIME,
            MEMBER_GUBUN,
            HIT,
            IFNULL(CONTENTS_TEXT, '') AS CONTENTS_TEXT,
            IFNULL(CONTENTS_IMG, '') AS CONTENTS_IMG,
            OPTION1_YN,
            OPTION2_YN,
            OPTION3_YN,
            OPTION4_YN,
            ONOFF_DIV,
            CASE
                WHEN START_DATE > DATE_FORMAT(NOW(), '%Y%m%d') THEN '대기중'
                WHEN START_DATE <![CDATA[<=]]> DATE_FORMAT(NOW(), '%Y%m%d')
                    AND CONCAT(END_DATE, END_TIME) >= DATE_FORMAT(NOW(), '%Y%m%d%H') THEN '진행중'
                WHEN CONCAT(END_DATE, END_TIME) <![CDATA[<]]> DATE_FORMAT(NOW(), '%Y%m%d%H') THEN '완료'
            END AS STATUS,
            (SELECT COUNT(*) FROM TB_EVENT_OPTION2 WHERE EVENT_NO = #{EVENT_NO}) AS COMMENT_CNT
        FROM TB_EVENT_INFO
        WHERE EVENT_NO = #{EVENT_NO}
    </select>

    <!-- 온라인 이벤트 첨부파일 목록 조회 -->
    <select id="onEventAttachFileList" parameterType="hashmap" resultType="hashmap">
        SELECT
            SEQ,
            EVENT_NO,
            FILE_PATH,
            FILE_NAME,
            REAL_FILE_NAME,
            DOWN_CNT,
            DATE_FORMAT(REG_DT, '%Y-%m-%d') AS REG_DT
        FROM TB_EVENT_FILE
        WHERE EVENT_NO = #{EVENT_NO}
        ORDER BY SEQ
    </select>

    <!-- 온라인 이벤트 강좌 목록 조회 -->
    <select id="onEventLectureList" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.SEQ,
            A.EVENT_NO,
            A.LECCODE,
            B.SUBJECT_TITLE,
            B.SUBJECT_TEACHER,
            (SELECT USER_NM FROM TB_MA_MEMBER WHERE USER_ID = B.SUBJECT_TEACHER) AS SUBJECT_TEACHER_NM,
            B.SUBJECT_PRICE,
            B.SUBJECT_DISCOUNT,
            DATE_FORMAT(A.REG_DT, '%Y-%m-%d') AS REG_DT
        FROM TB_EVENT_LECTURE A
        INNER JOIN TB_LEC_MST B ON A.LECCODE = B.LECCODE
        WHERE A.EVENT_NO = #{EVENT_NO}
        ORDER BY A.SEQ
    </select>

    <!-- 온라인 이벤트 댓글 목록 조회 -->
    <select id="onEventCommentList" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.SEQ,
            A.EVENT_NO,
            A.COMMENT_TEXT,
            DATE_FORMAT(A.REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT,
            A.REG_ID,
            (SELECT USER_NM FROM TB_MA_MEMBER WHERE USER_ID = A.REG_ID) AS USER_NM,
            (SELECT CONCAT(LEFT(USER_NM, 2), '***') FROM TB_MA_MEMBER WHERE USER_ID = A.REG_ID) AS USER_NM_MASK
        FROM TB_EVENT_OPTION2 A
        WHERE A.EVENT_NO = #{EVENT_NO}
        ORDER BY A.SEQ DESC
    </select>

    <!-- 온라인 이벤트 조회수 증가 -->
    <update id="updateOnEventHits" parameterType="hashmap">
        UPDATE TB_EVENT_INFO
        SET HIT = IFNULL(HIT, 0) + 1
        WHERE EVENT_NO = #{EVENT_NO}
    </update>

    <!-- 온라인 이벤트 댓글 등록 -->
    <insert id="insertOnEventComment" parameterType="hashmap">
        INSERT INTO TB_EVENT_OPTION2 (
            EVENT_NO,
            COMMENT_TEXT,
            REG_ID,
            REG_DT
        ) VALUES (
            #{EVENT_NO},
            #{COMMENT_TEXT},
            #{USER_ID},
            NOW()
        )
    </insert>

    <!-- 온라인 이벤트 댓글 삭제 -->
    <delete id="deleteOnEventComment" parameterType="hashmap">
        DELETE FROM TB_EVENT_OPTION2
        WHERE SEQ = #{SEQ}
          AND REG_ID = #{USER_ID}
    </delete>

    <!-- 온라인 이벤트 출석 체크 -->
    <insert id="insertOnEventAttendance" parameterType="hashmap">
        INSERT INTO TB_EVENT_ATTENDANCE (
            EVENT_NO,
            USER_ID,
            ATTENDANCE_DATE,
            REG_DT
        ) VALUES (
            #{EVENT_NO},
            #{USER_ID},
            #{ATTENDANCE_DATE},
            NOW()
        )
    </insert>

    <!-- 온라인 이벤트 출석 확인 -->
    <select id="checkOnEventAttendance" parameterType="hashmap" resultType="int">
        SELECT COUNT(*)
        FROM TB_EVENT_ATTENDANCE
        WHERE EVENT_NO = #{EVENT_NO}
          AND USER_ID = #{USER_ID}
          AND ATTENDANCE_DATE = #{ATTENDANCE_DATE}
    </select>

    <!-- 온라인 이벤트 출석 목록 조회 -->
    <select id="onEventAttendanceList" parameterType="hashmap" resultType="hashmap">
        SELECT
            EVENT_NO,
            USER_ID,
            ATTENDANCE_DATE,
            DATE_FORMAT(REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT
        FROM TB_EVENT_ATTENDANCE
        WHERE EVENT_NO = #{EVENT_NO}
          AND USER_ID = #{USER_ID}
        ORDER BY ATTENDANCE_DATE DESC
    </select>

</mapper>
