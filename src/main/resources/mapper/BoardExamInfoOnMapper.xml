<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.academy.mapper.BoardExamInfoOnMapper">

    <!-- 게시판 정보 조회 -->
    <select id="getBoardInfo" parameterType="hashmap" resultType="hashmap">
        SELECT
            BOARD_MNG_SEQ,
            BOARD_NM,
            BOARD_DESC,
            USE_YN
        FROM TB_BOARD_MNG
        WHERE BOARD_MNG_SEQ = #{BOARD_MNG_SEQ}
    </select>

    <!-- 시험정보 게시판 목록 조회 -->
    <select id="boardList" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.BOARD_SEQ,
            A.BOARD_MNG_SEQ,
            A.SUBJECT,
            A.HITS,
            A.REG_ID,
            A.REG_NM,
            DATE_FORMAT(A.REG_DT, '%Y-%m-%d') AS REG_DT,
            A.EXAM_TYPE,
            A.EXAM_AREA
        FROM TB_BOARD A
        WHERE A.BOARD_MNG_SEQ = #{BOARD_MNG_SEQ}
          AND A.DEL_YN = 'N'
        <if test="SEARCHTEXT != null and SEARCHTEXT != ''">
            <choose>
                <when test="SEARCHKIND == 'subject'">
                    AND A.SUBJECT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <when test="SEARCHKIND == 'content'">
                    AND A.CONTENT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <when test="SEARCHKIND == 'regNm'">
                    AND A.REG_NM LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <otherwise>
                    AND (A.SUBJECT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                         OR A.CONTENT LIKE CONCAT('%', #{SEARCHTEXT}, '%'))
                </otherwise>
            </choose>
        </if>
        <if test="SCH_EXAM_TYPE != null and SCH_EXAM_TYPE != ''">
            AND A.EXAM_TYPE = #{SCH_EXAM_TYPE}
        </if>
        <if test="SCH_EXAM_AREA != null and SCH_EXAM_AREA != ''">
            AND A.EXAM_AREA = #{SCH_EXAM_AREA}
        </if>
        ORDER BY A.NOTICE_TOP_YN DESC, A.REG_DT DESC, A.BOARD_SEQ DESC
        LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>

    <!-- 시험정보 게시판 목록 수 조회 -->
    <select id="boardListCount" parameterType="hashmap" resultType="int">
        SELECT COUNT(*)
        FROM TB_BOARD A
        WHERE A.BOARD_MNG_SEQ = #{BOARD_MNG_SEQ}
          AND A.DEL_YN = 'N'
        <if test="SEARCHTEXT != null and SEARCHTEXT != ''">
            <choose>
                <when test="SEARCHKIND == 'subject'">
                    AND A.SUBJECT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <when test="SEARCHKIND == 'content'">
                    AND A.CONTENT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <when test="SEARCHKIND == 'regNm'">
                    AND A.REG_NM LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                </when>
                <otherwise>
                    AND (A.SUBJECT LIKE CONCAT('%', #{SEARCHTEXT}, '%')
                         OR A.CONTENT LIKE CONCAT('%', #{SEARCHTEXT}, '%'))
                </otherwise>
            </choose>
        </if>
        <if test="SCH_EXAM_TYPE != null and SCH_EXAM_TYPE != ''">
            AND A.EXAM_TYPE = #{SCH_EXAM_TYPE}
        </if>
        <if test="SCH_EXAM_AREA != null and SCH_EXAM_AREA != ''">
            AND A.EXAM_AREA = #{SCH_EXAM_AREA}
        </if>
    </select>

    <!-- 게시물 상세 조회 -->
    <select id="boardView" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.BOARD_SEQ,
            A.BOARD_MNG_SEQ,
            A.SUBJECT,
            A.CONTENT,
            A.HITS,
            A.REG_ID,
            A.REG_NM,
            DATE_FORMAT(A.REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT,
            A.UPD_ID,
            DATE_FORMAT(A.UPD_DT, '%Y-%m-%d %H:%i:%s') AS UPD_DT,
            A.EXAM_TYPE,
            A.EXAM_AREA
        FROM TB_BOARD A
        WHERE A.BOARD_SEQ = #{BOARD_SEQ}
          AND A.DEL_YN = 'N'
    </select>

    <!-- 게시물 첨부파일 조회 -->
    <select id="boardAttachFile" parameterType="hashmap" resultType="hashmap">
        SELECT
            FILE_SEQ,
            BOARD_SEQ,
            FILE_PATH,
            FILE_NAME,
            REAL_FILE_NAME,
            FILE_SIZE,
            DATE_FORMAT(REG_DT, '%Y-%m-%d') AS REG_DT
        FROM TB_BOARD_FILE
        WHERE BOARD_SEQ = #{BOARD_SEQ}
          AND FILE_TYPE = 'F'
          AND DEL_YN = 'N'
        ORDER BY FILE_SEQ
    </select>

    <!-- 게시물 이미지 첨부파일 조회 -->
    <select id="boardAttachFileImg" parameterType="hashmap" resultType="hashmap">
        SELECT
            FILE_SEQ,
            BOARD_SEQ,
            FILE_PATH,
            FILE_NAME,
            REAL_FILE_NAME,
            FILE_SIZE,
            DATE_FORMAT(REG_DT, '%Y-%m-%d') AS REG_DT
        FROM TB_BOARD_FILE
        WHERE BOARD_SEQ = #{BOARD_SEQ}
          AND FILE_TYPE = 'I'
          AND DEL_YN = 'N'
        ORDER BY FILE_SEQ
    </select>

    <!-- 조회수 증가 -->
    <update id="updateBoardHits" parameterType="hashmap">
        UPDATE TB_BOARD
        SET HITS = IFNULL(HITS, 0) + 1
        WHERE BOARD_SEQ = #{BOARD_SEQ}
    </update>

    <!-- 공고 구분 코드 목록 조회 -->
    <select id="getPubGubun" parameterType="hashmap" resultType="hashmap">
        SELECT
            CODE,
            CODE_NM,
            CODE_DESC,
            SORT_ORDER
        FROM TB_CMM_CODE
        WHERE SYS_CD = #{SYS_CD}
          AND USE_YN = 'Y'
        ORDER BY SORT_ORDER
    </select>

    <!-- 공고 게시판 목록 조회 -->
    <select id="pubNoticeList" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.PUB_SEQ,
            A.PUB_TITLE,
            A.PUB_CONTENT,
            A.HITS,
            A.PUB_TYPE,
            A.PUB_AREA,
            DATE_FORMAT(A.REG_DT, '%Y-%m-%d') AS REG_DT,
            DATE_FORMAT(A.ST_DT, '%Y-%m-%d') AS ST_DT,
            DATE_FORMAT(A.ED_DT, '%Y-%m-%d') AS ED_DT
        FROM TB_PUB_NOTICE A
        WHERE A.DEL_YN = 'N'
          AND A.USE_YN = 'Y'
        <if test="sType != null">
            AND A.PUB_TYPE IN
            <foreach item="item" collection="sType" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ORDER BY A.REG_DT DESC
        LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>

    <!-- 공고 게시판 목록 수 조회 -->
    <select id="pubNoticeListCount" parameterType="hashmap" resultType="int">
        SELECT COUNT(*)
        FROM TB_PUB_NOTICE A
        WHERE A.DEL_YN = 'N'
          AND A.USE_YN = 'Y'
        <if test="sType != null">
            AND A.PUB_TYPE IN
            <foreach item="item" collection="sType" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <!-- 공고 상세 조회 -->
    <select id="pubNoticeView" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.PUB_SEQ,
            A.PUB_TITLE,
            A.PUB_CONTENT,
            A.HITS,
            A.PUB_TYPE,
            A.PUB_AREA,
            DATE_FORMAT(A.REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT,
            DATE_FORMAT(A.ST_DT, '%Y-%m-%d') AS ST_DT,
            DATE_FORMAT(A.ED_DT, '%Y-%m-%d') AS ED_DT
        FROM TB_PUB_NOTICE A
        WHERE A.PUB_SEQ = #{BOARD_SEQ}
          AND A.DEL_YN = 'N'
    </select>

    <!-- 공고 조회수 증가 -->
    <update id="updatePubNoticeHits" parameterType="hashmap">
        UPDATE TB_PUB_NOTICE
        SET HITS = IFNULL(HITS, 0) + 1
        WHERE PUB_SEQ = #{BOARD_SEQ}
    </update>

    <!-- 공고 첨부파일 조회 -->
    <select id="pubNoticeAttachFile" parameterType="hashmap" resultType="hashmap">
        SELECT
            FILE_SEQ,
            PUB_SEQ,
            FILE_PATH,
            FILE_NAME,
            REAL_FILE_NAME,
            FILE_SIZE,
            DATE_FORMAT(REG_DT, '%Y-%m-%d') AS REG_DT
        FROM TB_PUB_NOTICE_FILE
        WHERE PUB_SEQ = #{BOARD_SEQ}
          AND DEL_YN = 'N'
        ORDER BY FILE_SEQ
    </select>

    <!-- 공고 카테고리 조회 -->
    <select id="getPubCategorySel" parameterType="hashmap" resultType="hashmap">
        SELECT
            CATE_CD,
            CATE_NM,
            PARENT_CATE_CD,
            LVL,
            SORT_ORDER
        FROM TB_PUB_CATEGORY
        WHERE USE_YN = 'Y'
        <if test="LVL != null and LVL != ''">
            AND LVL = #{LVL}
        </if>
        ORDER BY SORT_ORDER
    </select>

</mapper>
